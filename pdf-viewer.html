<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; object-src 'self' blob: data:; frame-src 'self' blob: data:; base-uri 'self'">
  <title>Visor PDF</title>
  <style>
    html, body { height: 100%; margin: 0; background: #111; }
    #fallback { position: absolute; inset: 0; display: none; color: #fff; padding: 1rem; }
    embed, iframe { width: 100%; height: 100%; border: 0; }
  </style>
  <script src="js/sw-register.js"></script>
  <script>
    (function(){
      let mountedMode = '';
      function isTempPdfUrl(u){ try { const x = new URL(u, window.location.origin); return x.origin === window.location.origin && x.pathname.indexOf('/__pdf__/') !== -1; } catch (_) { return false; } }
      async function toBlobUrlIfCached(u){
        try {
          if (!isTempPdfUrl(u) || !('caches' in window)) return '';
          const resp = await caches.match(u, { ignoreSearch: true });
          if (!resp) return '';
          const blob = await resp.blob();
          if (!blob || !blob.size) return '';
          return URL.createObjectURL(blob);
        } catch (_) { return ''; }
      }
      function getParamUrl() {
        try {
          const u = new URL(window.location.href);
          const fromSearch = u.searchParams.get('u');
          if (fromSearch) return fromSearch;
          if (u.hash && u.hash.length > 1) {
            const hash = u.hash.substring(1);
            if (hash.startsWith('u=')) return decodeURIComponent(hash.substring(2));
          }
        } catch (_) {}
        return '';
      }
      function clearBody(){
        while (document.body.firstChild) document.body.removeChild(document.body.firstChild);
      }
      function mountWithUrl(url){
        if (mountedMode === 'url') return;
        mountedMode = 'url';
        clearBody();
        const emb = document.createElement('embed');
        emb.type = 'application/pdf';
        emb.src = url;
        emb.style.width = '100%';
        emb.style.height = '100%';
        document.body.appendChild(emb);
      }
      function mountWithDataUrl(dataUrl){
        if (mountedMode === 'data') return;
        mountedMode = 'data';
        clearBody();
        const emb = document.createElement('embed');
        emb.type = 'application/pdf';
        emb.src = dataUrl;
        emb.style.width = '100%';
        emb.style.height = '100%';
        document.body.appendChild(emb);
      }
      window.addEventListener('message', (ev) => {
        try {
          const d = ev.data || {};
          if (d && d.type === 'OPEN_PDF_URL' && typeof d.url === 'string') {
            (async () => {
              const local = await toBlobUrlIfCached(d.url);
              mountWithUrl(local || d.url);
            })();
            return;
          }
          if (d && d.type === 'OPEN_PDF_DATA' && typeof d.dataUrl === 'string') { mountWithDataUrl(d.dataUrl); return; }
          if (d && d.type === 'OPEN_PDF_BLOB' && d.blob) {
            const url = URL.createObjectURL(d.blob);
            mountWithUrl(url); return;
          }
        } catch (_) {}
      });
      // Señal para el opener (opcional)
      try { window.opener && window.opener.postMessage({ type: 'PDF_VIEWER_READY' }, '*'); } catch (_) {}
      // Si viene una URL en la query/hash, montarla directamente
      const initial = getParamUrl();
      if (initial) {
        (async () => {
          const local = await toBlobUrlIfCached(initial);
          try { mountWithUrl(local || initial); } catch (_) {}
        })();
      }
      // Fallback si nadie nos manda nada
      setTimeout(() => {
        if (!mountedMode) {
          const el = document.getElementById('fallback');
          el.style.display = 'block';
          el.textContent = 'No se recibió el PDF. Cierra esta pestaña e inténtalo de nuevo.';
        }
      }, 4000);
    })();
  </script>
  </head>
  <body>
    <div id="fallback">Cargando…</div>
  </body>
</html>
